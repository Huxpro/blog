
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->

<head>


<meta charset="utf-8">
<meta http-equiv="cleartype" content="on">

<title>Ruby Virtualenvs - Bits, Bytes, and Words</title>
<meta name="author" content="Jake Zimmerman">




<meta name="description" content="After some research, I found a much better solution to the problem of sandboxing Ruby gems.
">

<meta name="keywords" content="python ruby ">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Twitter Cards -->


<!-- Open Graph -->
<meta property="og:local" content="en_US">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.jez.io/ruby-virtualenvs">
<meta property="og:title" content="Ruby Virtualenvs">
<meta property="og:description" content="After some research, I found a much better solution to the problem of sandboxing Ruby gems.
">

  <meta property="og:image" content="">

<meta property="og:site_name" content="Bits, Bytes, and Words">

<link rel="canonical" href="https://blog.jez.io/ruby-virtualenvs">
<link href="/favicon.png" rel="icon">
<link href="/fonts/concourse.css" rel="stylesheet">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
<link href="/atom.xml" rel="alternate" title="Bits, Bytes, and Words" type="application/atom+xml">

<script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>
<script>Modernizr || document.write('<script src="/javascripts/vendor/modernizr-2.6.2.custom.min.js"><\/script>') </script>







</head>

<body id="post" class="">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
  <button class="dl-trigger">Open Menu</button>
  <ul class="dl-menu">
    <li><a href="/">All Posts</a></li><li><a href="/categories#fragment">Fragments</a></li><li><a href="/categories/">Posts by Category</a></li><li><a href="https://jez.io">About Jake</a></li><li><a href="https://github.com/jez">GitHub</a></li>
  </ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->




<div id="main" role="main">
  <article class="hentry">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title">Ruby Virtualenvs</h1>
        
        <h2>December 22, 2014</h2>
        
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content">
      <p>A while back I found a command that removes all Ruby gems installed on a system
when you&rsquo;re using rbenv. It worked great, so I decided to build on top of it.
After a bit of research, I found a much better solution to the root of my
problems: sandboxing Ruby gems.</p>

<!-- more -->


<h2>Ugh, Ruby&hellip;</h2>

<p>If you&rsquo;re anything like me, you can never do anything right on the first try
using Ruby. At one point, I found myself needing a script to just nuke
everything and start over&hellip; That&rsquo;s when I found Ian Vaughan&rsquo;s <a href="https://gist.github.com/IanVaughan/2902499">script</a> that
magically removes all gems. I was delighted to see that it worked perfectly on
the first try, and went about the rest of my business.</p>

<h2>Modifications</h2>

<p>There were two ways though in which this script&rsquo;s functionality differed from
what I wanted it to do: it always removed <strong>all</strong> gems, and it left behind a
<code>.ruby_version</code> file after it was used, clobbering any file that might have been
there before.</p>

<p>In my updated script, you can specify a list of ruby versions as arguments, and
it will only gems from those versions instead of all of them.  Also, it saves
and restores the value of the old <code>.ruby_version</code> file once it&rsquo;s done.</p>

<p>The new script is available <a href="https://gist.github.com/jez/cc2ba08062c6183a489c">as a fork of the original Gist</a> and also as
a part of of <a href="https://github.com/jez/bin/blob/master/uninstall_gems">my personal bin folder</a>.</p>

<h2>The Underlying Problem: Virtualenv&rsquo;s in Ruby</h2>

<p>After a bit of reflection, I realized I should be trying to solve the underlying
problem: different projects had different dependencies, and gems from one
project were bleeding into gems from another. If you&rsquo;re a Python developer, you
don&rsquo;t have this issue: <a href="http://virtualenvwrapper.readthedocs.org/en/latest/">virtualenvwrapper</a>, <code>pip</code>, and <code>requirements.txt</code>
files make this a non-issue.</p>

<p>After looking into if there existed a similar Ruby solution, I came up with
<a href="http://honza.ca/2011/06/install-ruby-gems-into-virtualenv">this blog post</a> outlining how you can do the exact same thing using
virtualenvs but with Ruby gems! Once again, it needed a little bit of
modification so that everything works again as you&rsquo;d expect when you
<code>deactivate</code>. Add these lines to your virtualenv&rsquo;s <code>postactivate</code> script:</p>

<figure class='code'><figcaption><span>$VIRTUAL_ENV/bin/postactivate</span></figcaption><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">export</span> <span class="n">OLD_GEMHOME</span><span class="o">=</span><span class="s">"$GEM_HOME"</span>
</span><span class='line'><span class="n">export</span> <span class="n">GEM_HOME</span><span class="o">=</span><span class="s">"$VIRTUAL_ENV/gems"</span>
</span><span class='line'>
</span><span class='line'><span class="n">export</span> <span class="n">OLD_GEM_PATH</span><span class="o">=</span><span class="s">"$GEM_PATH"</span>
</span><span class='line'><span class="n">export</span> <span class="n">GEM_PATH</span><span class="o">=</span><span class="s">""</span>
</span><span class='line'>
</span><span class='line'><span class="n">export</span> <span class="n">OLD_PATH</span><span class="o">=</span><span class="s">"$PATH"</span>
</span><span class='line'><span class="n">export</span> <span class="n">PATH</span><span class="o">=</span><span class="s">"$GEM_HOME/bin:$PATH"</span></span></code></pre></td></tr></table></div></figure>


<p>And then add this complementary section to your <code>predeactivate</code> script:</p>

<figure class='code'><figcaption><span>$VIRTUAL_ENV/bin/predeactivate</span></figcaption><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">export</span> <span class="n">GEM_HOME</span><span class="o">=</span><span class="s">"$OLD_GEM_HOME"</span>
</span><span class='line'><span class="n">unset</span> <span class="n">OLD_GEM_HOME</span>
</span><span class='line'>
</span><span class='line'><span class="n">export</span> <span class="n">GEM_PATH</span><span class="o">=</span><span class="s">"$OLD_GEM_PATH"</span>
</span><span class='line'><span class="n">unset</span> <span class="n">OLD_GEM_PATH</span>
</span><span class='line'>
</span><span class='line'><span class="n">export</span> <span class="n">PATH</span><span class="o">=</span><span class="s">"$OLD_PATH"</span>
</span><span class='line'><span class="n">unset</span> <span class="n">OLD_PATH</span></span></code></pre></td></tr></table></div></figure>


<p>Now, whenever you install gems, they&rsquo;ll install to the folder
<code>$VIRTUAL_ENV/gems/</code> instead of the system&rsquo;s location, so no gems bleed into
another project!</p>

<h2>One Step Further</h2>

<p>Bringing up this web page, copying those snippets, and pasting them in the two
necessary files every time is a bit tedious. To automate this process, we can
tap into virtualenvwrapper&rsquo;s configurability using hooks. Instead of dropping
those snippets into <code>$VIRTUAL_ENV/bin/{post,prede}activate,</code>, place them in
<code>$VIRTUALENVWRAPPER_HOOK_DIR/{post,prede}activate</code>.</p>

<p>Now every time you <code>workon</code> a virtualenv, the appropriate configuration will
be set up. Note that this means every normal Python project you use will have
this Ruby configuration added (not just the Ruby projects), but that shouldn&rsquo;t
matter because they interoperate nicely. If it&rsquo;s really an issue, you can stick
with the per-virtualenv solution above.</p>

<p>Note: a side effect of this nice sandboxing is that you can normally run
commands without prefixing them with <code>bundle exec ...</code>, which is actually really
handy.</p>

      <footer class="entry-meta">
        <span class="entry-tags"><a href="/categories/#python" title="Pages tagged python" class="tag">python</a><a href="/categories/#ruby" title="Pages tagged ruby" class="tag">ruby</a></span>
        <span class="entry-date date published updated"><time datetime="2014-12-22T12:52:40-06:00">December 22, 2014</time></span>
        
      </footer>
    </div><!-- /.entry-content -->
    
      <div class="read-more">
        
          <div class="read-more-header">
            <a href="/flow-exhaustiveness/" class="btn">Read More</a>
          </div><!-- /.read-more-header -->
          <div class="read-more-content">
            <h3><a href="/flow-exhaustiveness/" title="Case Exhaustiveness in Flow">Case Exhaustiveness in Flow</a></h3>
            <p>Compared to some other languages, Flow&#8217;s story around exhaustiveness checking within &#8216;if / else&#8217; and &#8216;switch&#8217; statements leaves something to be desired. By default, Flow doesn&#8217;t do any exhaustiveness checks! But we can opt-in to exhaustiveness checking one statement at a time. In this post, we&#8217;ll discover from the ground up how Flow&#8217;s exhaustiveness checking behaves.
 <a href="/flow-exhaustiveness/"> Continue reading</a></p>
          </div><!-- /.read-more-content -->
        
        <div class="read-more-list">
          
            <div class="list-item">
              <h4><a href="/lens-composition/" title="Lenses & Composition">Lenses & Composition</a></h4>
              <span>Published on February 06, 2018</span>
            </div><!-- /.list-item -->
          
            <div class="list-item">
              <h4><a href="/lens-intuition/" title="Some Intuition on Lenses">Some Intuition on Lenses</a></h4>
              <span>Published on February 06, 2018</span>
            </div><!-- /.list-item -->
          
        </div><!-- /.read-more-list -->
      </div><!-- /.read-more -->
    
    
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2018 Jake Zimmerman. Powered by <a href="http://octopress.org">Octopress</a> using the <a href="https://github.com/jez/hpstr-theme/">HPSTR Theme for Octopress</a>.</span>

  </footer>
</div><!-- /.footer-wrapper -->


	        
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/javascripts/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/javascripts/scripts.min.js"></script>
&#8211;>
	        

</body>
</html>
